version: "3.9"

services:

  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "${MQTT_PORT}:1883"
      - "9001:9001"
    volumes:
      - ./mqtt_conf:/mosquitto/config

  fastapi-app:
    build: .
    container_name: fastapi-fast_server
    env_file:
      - .env
    environment:
      - MQTT_HOST=mqtt-broker
      - NTP_SERVER=ntp
      # IPs
      - PGHOST=${DB_HOST}
      # Database Login Info
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASSWORD}
      - PGDATABASE=${DB_NAME}
      # Batched Config
      - QUEUE_SIZE=${QUEUE_SIZE}
      - B_TIMEOUT=${B_TIMEOUT}
      - BATCHES=${BATCHES}
      # Ports
      - MQTT_PORT=${MQTT_PORT}
      - ROBOT_TCP_PORT=${ROBOT_TCP_PORT}
      - PGPORT=${PGPORT}
    ports:
      - "${FASTAPI_PORT}:8000"
    volumes:
      - nas_backups:/db_backups
      - logs:/fast_server/logs
    depends_on:                
      - mqtt-broker

  web:
      build:
        context: ./web
      container_name: web-frontend
      ports:
        - "${WEB_PORT}:80"
      depends_on:
        - fastapi-app

  tcp:
    build:
      context: .            
      dockerfile: tcp_server/dockerfile

    container_name: tcp-fast_server
    env_file:
      - .env
    environment:
      - PGHOST=${DB_HOST}
      - NTP_SERVER=ntp
      - PGPORT=5433
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASSWORD}
      - PGDATABASE=${DB_NAME}
      - BATCHES=${BATCHES}
      - B_TIMEOUT=${B_TIMEOUT}
      - QUEUE_SIZE=${QUEUE_SIZE}
      - ROBOT_TCP_PORT=5001
    ports:
      - "${ROBOT_TCP_PORT}:5001"
    volumes:
      - logs:/fast_server/logs

  ntp:
    image: cturra/ntp:latest
    container_name: ntp
    restart: unless-stopped
    ports:
      - "${NTP_PORT}:123/udp"
    environment:
      - TZ=America/Chicago
      - NTP_SERVERS="time1.google.com,time2.google.com,time3.google.com,time4.google.com"
    cap_add:
      - SYS_NICE
      - SYS_TIME
    volumes:
      - /etc/localtime:/etc/localtime:ro

volumes:
  chrony-state:
  nas_backups:
    driver_opts:
      type: "nfs"
      o: "addr=${DB_HOST},nolock,soft,rw"
      device: ":/volume1/docker/postgres/backups"
  logs:
    driver_opts:
      type: "nfs"
      o: "addr=${DB_HOST},nolock,soft,rw"
      device: ":/volume1/docker/postgres/logs"