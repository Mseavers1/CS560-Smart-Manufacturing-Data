CREATE TABLE device (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    label VARCHAR(50) NOT NULL UNIQUE,
    category VARCHAR(50) NOT NULL,
    ip_address INET NOT NULL,
    registered_at DOUBLE PRECISION NOT NULL
);

CREATE TABLE session (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    label VARCHAR(100) NOT NULL UNIQUE,
    started_at DOUBLE PRECISION NOT NULL,
    ended_at DOUBLE PRECISION NULL,
    CONSTRAINT session_time_chk CHECK (ended_at IS NULL OR ended_at >= started_at)
);

CREATE TABLE session_device (
    device_id INTEGER NOT NULL,
    session_id BIGINT NOT NULL,
    PRIMARY KEY (device_id, session_id),
    FOREIGN KEY (device_id) REFERENCES device(id) ON DELETE CASCADE,
    FOREIGN KEY (session_id) REFERENCES session(id) ON DELETE CASCADE
);

CREATE TABLE imu_measurement (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    device_id INTEGER NOT NULL REFERENCES device(id) ON DELETE CASCADE,
    session_id BIGINT NOT NULL REFERENCES session(id) ON DELETE CASCADE,
    accel_x DOUBLE PRECISION NOT NULL,
    accel_y DOUBLE PRECISION NOT NULL,
    accel_z DOUBLE PRECISION NOT NULL,
    gyro_x DOUBLE PRECISION NOT NULL,
    gyro_y DOUBLE PRECISION NOT NULL,
    gyro_z DOUBLE PRECISION NOT NULL,
    mag_x DOUBLE PRECISION NOT NULL,
    mag_y DOUBLE PRECISION NOT NULL,
    mag_z DOUBLE PRECISION NOT NULL,
    yaw DOUBLE PRECISION NOT NULL,
    pitch DOUBLE PRECISION NOT NULL,
    roll DOUBLE PRECISION NOT NULL,
    recorded_at DOUBLE PRECISION NOT NULL,
    ingested_at DOUBLE PRECISION NOT NULL
);

CREATE TABLE image_detection (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    frame_idx BIGINT NOT NULL,
    marker_idx INTEGER NOT NULL,
    rvec_x DOUBLE PRECISION NOT NULL,
    rvec_y DOUBLE PRECISION NOT NULL,
    rvec_z DOUBLE PRECISION NOT NULL,
    tvec_x DOUBLE PRECISION NOT NULL,
    tvec_y DOUBLE PRECISION NOT NULL,
    tvec_z DOUBLE PRECISION NOT NULL,
    image_path VARCHAR(512) NOT NULL,
    recorded_at DOUBLE PRECISION NOT NULL,
    ingested_at DOUBLE PRECISION NOT NULL,
    device_id INTEGER NOT NULL REFERENCES device(id) ON DELETE CASCADE,
    session_id BIGINT NOT NULL REFERENCES session(id) ON DELETE CASCADE
);

CREATE TABLE robot (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ts_epoch DOUBLE PRECISION NOT NULL,
    joint_1 DOUBLE PRECISION NOT NULL,
    joint_2 DOUBLE PRECISION NOT NULL,
    joint_3 DOUBLE PRECISION NOT NULL,
    joint_4 DOUBLE PRECISION NOT NULL,
    joint_5 DOUBLE PRECISION NOT NULL,
    joint_6 DOUBLE PRECISION NOT NULL,
    x DOUBLE PRECISION NOT NULL,
    y DOUBLE PRECISION NOT NULL,
    z DOUBLE PRECISION NOT NULL,
    w DOUBLE PRECISION NOT NULL,
    p DOUBLE PRECISION NOT NULL,
    r DOUBLE PRECISION NOT NULL,
    recorded_at DOUBLE PRECISION NOT NULL,
    ingested_at DOUBLE PRECISION NOT NULL,
    device_id INTEGER NOT NULL REFERENCES device(id) ON DELETE CASCADE,
    session_id BIGINT NOT NULL REFERENCES session(id) ON DELETE CASCADE
);

CREATE INDEX ON session_device (device_id);
CREATE INDEX ON session_device (session_id);
CREATE INDEX ON imu_measurement (device_id, recorded_at DESC);
CREATE INDEX ON image_detection (device_id, recorded_at DESC);
CREATE INDEX ON robot (device_id, recorded_at DESC);