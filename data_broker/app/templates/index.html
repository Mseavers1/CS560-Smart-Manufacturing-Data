<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Broker Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, serif;
      background: #000;
      min-height: 100vh;
      padding: 20px;
      color: #4d4dff;
    }

    .dashboard-card {
      background-image: radial-gradient(#000000 1.5px, #ffffffc5 2px);
      background-size: 20px 20px;
      border-radius: 15px;
      width: 100%;
      min-height: calc(100vh - 20px);
      box-shadow: 0 10px 30px rgba(0, 0, 238, 0.3);
      padding: 30px;
    }

    .dashboard-header {
      margin-bottom: 20px;
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .dashboard-header h1 {
      color: #000;
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .dashboard-content {
      color: #4d4dff;
    }

    .row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      height: 350px;
    }

    .box {
      flex: 1;
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 238, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .box h2 {
      color: #000;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .box-content {
      flex: 1;
      overflow-y: auto;
    }

    .item-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .item-list li {
      padding: 10px;
      margin-bottom: 8px;
      background: #ffffff;
      border-radius: 8px;
      color: #000000;
      font-size: 14px;
    }

    .item-list li:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 238, 0.2);
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f5f5ff;
      padding: 10px;
      border-radius: 8px;
      color: #000;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="dashboard-card">
    <div class="dashboard-header">
      <h1>Data Broker Dashboard</h1>
      <p id="timestamp">Connecting...</p>
    </div>

    <div class="dashboard-content">
      <!-- System / SMR -->
      <div class="row">
        <div class="box">
          <h2>System Status</h2>
          <div class="box-content">
            <ul class="item-list" id="sysStatus">
              <li>Loading system data...</li>
            </ul>
          </div>
        </div>
      </div>


        <!-- MQTT Publish -->
      <div class="row">
        <div class="box">
          <h2>MQTT Messages</h2>
          <div class="box-content">
            <ul class="item-list" id="publishLog">
                <li>Waiting for live messages...</li>
            </ul>
          </div>
        </div>
      </div>

        <div class="row">
            <div class="box">
                <h2>Robot Live Feed</h2>
                <div class="box-content">
                    <ul class="item-list" id="robotFeed">
                        <li>Waiting for robot data‚Ä¶</li>
                    </ul>
                </div>
            </div>
        </div>


      <!-- Backups & MQTT -->
      <div class="row">
        <div class="box">
          <h2>Backups</h2>
          <div class="box-content">
            <ul class="item-list" id="backupList">
              <li>No backups found.</li>
            </ul>
          </div>
        </div>

        <div class="box">
          <h2>MQTT Broker</h2>
          <div class="box-content">
            <ul class="item-list" id="mqttList">
              <li>Waiting for broker status...</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Connections -->
      <div class="row">
        <div class="box">
          <h2>Active Connections</h2>
          <div class="box-content">
            <ul class="item-list" id="connections">
              <li>No active connections detected.</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const es = new EventSource("/events/metrics");
    es.onmessage = (evt) => {
      const data = JSON.parse(evt.data);
      document.getElementById("timestamp").textContent = 
        `Last updated: ${new Date(data.timestamp).toLocaleTimeString()}`;

      // --- System Status ---
      const sys = [];
      sys.push(`Host: ${data.host.name}`);
      sys.push(`Platform: ${data.host.platform}`);
      sys.push(`CPU Usage: ${data.cpu.percent.toFixed(1)}%`);
      sys.push(`Memory: ${data.memory.percent.toFixed(1)}% used`);
      sys.push(`Disk: ${data.disk.percent.toFixed(1)}% used`);
      sys.push(`Uptime: ${(data.uptime / 3600).toFixed(1)} hours`);
      sys.push(`Network Sent: ${(data.network.bytes_sent / 1e6).toFixed(2)} MB`);
      sys.push(`Network Received: ${(data.network.bytes_recv / 1e6).toFixed(2)} MB`);
      sys.push(`Latency: ${data.network.latency_ms ? data.network.latency_ms.toFixed(1) + " ms" : "N/A"}`);
      document.getElementById("sysStatus").innerHTML = sys.map(s => `<li>${s}</li>`).join("");

      // --- Backups ---
      if (data.backups && data.backups.length > 0) {
        const backups = data.backups.slice(0, 10).map(b =>
          `<li>${b.name} - ${(b.size / 1024 / 1024).toFixed(2)} MB<br><small>${new Date(b.modified).toLocaleString()}</small></li>`
        );
        document.getElementById("backupList").innerHTML = backups.join("");
      } else {
        document.getElementById("backupList").innerHTML = "<li>No backups available</li>";
      }

      // --- MQTT Broker ---
      const mqtt = [];
      mqtt.push(`Connected: ${data.mqtt.is_connected}`);
      mqtt.push(`Host: ${data.mqtt.broker_host}:${data.mqtt.broker_port}`);
      if (data.mqtt.subscriptions && data.mqtt.subscriptions.length)
        mqtt.push(`Subscriptions: ${data.mqtt.subscriptions.join(", ")}`);
      else mqtt.push("No subscriptions active");
      document.getElementById("mqttList").innerHTML = mqtt.map(s => `<li>${s}</li>`).join("");

      // --- Connections ---
      if (data.connections && data.connections.length > 0) {
        const connItems = data.connections.slice(0, 15).map(c =>
          `<li>${c.local} ‚Üí ${c.remote}<br><small>${c.status} (PID: ${c.pid ?? "?"})</small></li>`
        );
        document.getElementById("connections").innerHTML = connItems.join("");
      } else {
        document.getElementById("connections").innerHTML = "<li>No active network connections</li>";
      }
    };

    es.onerror = () => {
      document.getElementById("timestamp").textContent = "‚ö†Ô∏è Disconnected from server. Retrying...";
    };

    // New MQTT live feed
    const mqttStream = new EventSource("/events/mqtt");
    const publishList = document.getElementById("publishLog"); // add this <ul> in HTML

    mqttStream.onmessage = (evt) => {
        const li = document.createElement("li");
        li.textContent = evt.data;
        publishList.prepend(li);
        if (publishList.children.length > 50) {
        publishList.removeChild(publishList.lastChild);
        }
    };

    mqttStream.onerror = () => {
        console.warn("MQTT SSE disconnected, retrying...");
    };

      const robotES = new EventSource("/events/robot");
  const robotFeed = document.getElementById("robotFeed");

  function addRobotLine(text) {
    const li = document.createElement("li");
    li.textContent = text;
    robotFeed.prepend(li);
    while (robotFeed.children.length > 100) {
      robotFeed.removeChild(robotFeed.lastChild);
    }
  }

  robotES.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type === "robot_data") {
        addRobotLine(`[${msg.ts}] ${msg.peer} | joints=${msg.joints.map(x=>x.toFixed(2)).join(", ")} | pose=${msg.pose.map(x=>x.toFixed(2)).join(", ")}`);
      } else if (msg.type === "connection_open") {
        addRobotLine(`[${msg.ts}] üöÄ Robot connected: ${msg.peer}`);
      } else if (msg.type === "connection_close") {
        addRobotLine(`[${msg.ts}] üì¥ Robot disconnected: ${msg.peer}`);
      } else if (msg.type === "info") {
        addRobotLine(`[${msg.ts}] ‚ÑπÔ∏è ${msg.msg}`);
      } else {
        addRobotLine(evt.data);
      }
    } catch {
      addRobotLine(evt.data);
    }
  };

  robotES.onerror = () => {
    addRobotLine("‚ö†Ô∏è Robot SSE disconnected, retrying‚Ä¶");
  };
  </script>
</body>
</html>
