version: "3.9"

services:

  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt_conf:/mosquitto/config

  fastapi-app:
    build: .
    container_name: fastapi-app
    env_file:
      - .env
    environment:
      # existing
      - MQTT_HOST=mqtt-broker
      - NTP_SERVER=ntp
      - ROBOT_TCP_PORT=5001
      - MQTT_PORT=1883
      - PGHOST=192.168.1.111
      - PGPORT=5433
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASSWORD}
      - PGDATABASE=${DB_NAME}
      - BATCHES=${BATCHES}
      - QUEUE_SIZE=${QUEUE_SIZE}
      - B_TIMEOUT=${B_TIMEOUT}
    ports:
      - "8000:8000"
    volumes:
      - nas_backups:/db_backups
      - logs:/app/logs
    depends_on:                
      - mqtt-broker

  web:
      build:
        context: ./web
      container_name: web-frontend
      ports:
        - "80:80"
      depends_on:
        - fastapi-app

  tcp:
    build:
      context: .            
      dockerfile: tcp_server/dockerfile

    container_name: tcp-server
    env_file:
      - .env
    environment:
      - PGHOST=192.168.1.111
      - NTP_SERVER=ntp
      - PGPORT=5433
      - PGUSER=${DB_USER}
      - PGPASSWORD=${DB_PASSWORD}
      - PGDATABASE=${DB_NAME}
      - BATCHES=${BATCHES}
      - B_TIMEOUT=${B_TIMEOUT}
      - QUEUE_SIZE=${QUEUE_SIZE}
      - ROBOT_TCP_PORT=5001
    ports:
      - "5001:5001"
    volumes:
      - logs:/app/logs
      

  ntp:
    image: cturra/ntp:latest
    container_name: ntp
    restart: unless-stopped
    ports:
      - "123:123/udp"
    environment:
      - TZ=America/Chicago
      - NTP_SERVERS="time1.google.com,time2.google.com,time3.google.com,time4.google.com"
    # read_only: true
    # tmpfs:                             
    #   - /etc/chrony:rw,mode=1750
    #   - /run/chrony:rw,mode=1750
    #   - /var/lib/chrony:rw,mode=1750
    cap_add:
      - SYS_NICE
      - SYS_TIME
    volumes:
      - /etc/localtime:/etc/localtime:ro


volumes:
  chrony-state:
  nas_backups:
    driver_opts:
      type: "nfs"
      o: "addr=192.168.1.111,nolock,soft,rw"
      device: ":/volume1/docker/postgres/backups"
  logs:
    driver_opts:
      type: "nfs"
      o: "addr=192.168.1.111,nolock,soft,rw"
      device: ":/volume1/docker/postgres/logs"